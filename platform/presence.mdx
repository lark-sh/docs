---
title: "OnDisconnect and presence"
description: "Detect when users go offline and clean up automatically"
---

Knowing when users are online and offline is essential for multiplayer games, collaborative tools, and social apps. Lark provides server-side disconnect handling and a connection state indicator so you can build reliable presence systems.

## OnDisconnect

OnDisconnect lets you register operations that run on the server the moment a client disconnects. You set them up while connected, and the server holds onto them. When the connection drops — whether the user closes the tab, the network fails, or the device crashes — the server executes them immediately.

### Available operations

OnDisconnect supports the same write operations you use elsewhere:

- **set** — Overwrite the data at the path.
- **update** — Merge values into the existing data.
- **remove** — Delete the data at the path.
- **cancel** — Cancel any previously queued OnDisconnect operations for this path.

<Note>
OnDisconnect operations survive brief network interruptions. The server only executes them when it confirms the connection is truly gone — not on every momentary blip. If the client reconnects before the server times out the connection, the disconnect operations remain queued and are not fired.
</Note>

## `.info/connected`

Lark provides a special read-only path, `.info/connected`, that tells you whether the client is currently connected to the server. It's `true` when connected and `false` when disconnected.

Subscribe to it to show a connection indicator in your UI — a banner, an icon, a "reconnecting..." message.

## Building a presence system

The classic pattern for presence combines OnDisconnect, `.info/connected`, and regular writes:

1. Subscribe to `.info/connected`.
2. When the connection is established (or re-established), register an OnDisconnect to set the user offline and write a `lastSeen` timestamp.
3. Once the OnDisconnect is confirmed queued on the server, set the user online.
4. If the connection drops, the server executes the OnDisconnect — setting the user offline.
5. When the client reconnects, the cycle repeats.

<Tip>
The order matters. Always register your OnDisconnect **before** setting the online status. If you did it the other way around and the connection dropped between the two operations, the user would appear online forever with no disconnect handler to clean up.
</Tip>

### Multiple connections per user

OnDisconnect operations are tied to a specific connection. If a user opens your app in two tabs, each tab has its own connection and its own OnDisconnect handlers. Closing one tab fires that tab's disconnect operations — potentially setting the user offline while they're still active in the other tab. Design your presence data model to handle this if needed (for example, by tracking connection count instead of a boolean).

## Next steps

<Card title="Lark SDK OnDisconnect" icon="code" href="/lark-sdk/ondisconnect">
  Full API reference and code examples for OnDisconnect and presence in the Lark SDK.
</Card>
